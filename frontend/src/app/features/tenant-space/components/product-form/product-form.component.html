<div class="container mx-auto p-4">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold">{{ pageTitle }}</h1>
        <button mat-button (click)="cancel()">Retour</button>
    </div>

    <form [formGroup]="form" (ngSubmit)="onSubmit()" class="bg-white shadow-md rounded px-8 pt-6 pb-8 mb-4">

        <mat-tab-group>
            <!-- Tab 1: General -->
            <mat-tab label="Général">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
                    <mat-form-field appearance="outline" class="w-full">
                        <mat-label>Nom du Produit</mat-label>
                        <input matInput formControlName="name">
                        <mat-error *ngIf="form.get('name')?.hasError('required')">Requis</mat-error>
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="w-full">
                        <mat-label>SKU (Code Unique)</mat-label>
                        <input matInput formControlName="sku">
                        <mat-error *ngIf="form.get('sku')?.hasError('required')">Requis</mat-error>
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="w-full">
                        <mat-label>Catégorie</mat-label>
                        <input matInput formControlName="category">
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="w-full md:col-span-2">
                        <mat-label>Description</mat-label>
                        <textarea matInput formControlName="description" rows="3"></textarea>
                    </mat-form-field>
                </div>
            </mat-tab>

            <!-- Tab 2: Pricing -->
            <mat-tab label="Prix & Marge">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
                    <mat-form-field appearance="outline" class="w-full">
                        <mat-label>Prix de Vente (€)</mat-label>
                        <input matInput type="number" formControlName="salePrice">
                    </mat-form-field>

                    <div *ngIf="canSeePurchasePrice" class="relative">
                        <mat-form-field appearance="outline" class="w-full">
                            <mat-label>Prix d'Achat (€) (Privé)</mat-label>
                            <input matInput type="number" formControlName="purchasePrice">
                            <mat-icon matSuffix>lock</mat-icon>
                        </mat-form-field>
                    </div>

                    <div class="md:col-span-2 p-4 bg-gray-50 rounded"
                        *ngIf="marginPercentage !== null && canSeePurchasePrice">
                        <span class="font-bold">Marge Brute Estimée : </span>
                        <span [class.text-green-600]="marginPercentage >= 30"
                            [class.text-red-600]="marginPercentage < 30">
                            {{ marginPercentage | number:'1.2-2' }} %
                        </span>
                    </div>
                </div>
            </mat-tab>

            <!-- Tab 3: Variants -->
            <mat-tab label="Variantes">
                <div class="mt-6">
                    <div class="mb-4">
                        <mat-checkbox formControlName="hasVariants">Ce produit a des variantes (Taille,
                            Couleur...)</mat-checkbox>
                    </div>

                    <div *ngIf="form.get('hasVariants')?.value" formArrayName="variants">
                        <div *ngFor="let variant of variants.controls; let i=index" [formGroupName]="i"
                            class="flex gap-4 items-center mb-2 border p-2 rounded">
                            <mat-form-field appearance="outline" class="w-1/4">
                                <mat-label>SKU Variante</mat-label>
                                <input matInput formControlName="sku">
                            </mat-form-field>

                            <mat-form-field appearance="outline" class="w-1/4">
                                <mat-label>Taille</mat-label>
                                <input matInput formControlName="size">
                            </mat-form-field>

                            <mat-form-field appearance="outline" class="w-1/4">
                                <mat-label>Couleur</mat-label>
                                <input matInput formControlName="color">
                            </mat-form-field>

                            <button mat-icon-button color="warn" (click)="removeVariant(i)" type="button">
                                <mat-icon>delete</mat-icon>
                            </button>
                        </div>

                        <button mat-stroked-button color="primary" (click)="addVariant()" type="button">
                            <mat-icon>add</mat-icon> Ajouter une variante
                        </button>
                    </div>
                </div>
            </mat-tab>

        </mat-tab-group>

        <div class="flex items-center justify-end mt-6 gap-4 border-t pt-4">
            <button mat-button type="button" (click)="cancel()">Annuler</button>
            <button mat-flat-button color="primary" type="submit" [disabled]="form.invalid || isSubmitting">
                Enregistrer
            </button>
        </div>
    </form>
</div>